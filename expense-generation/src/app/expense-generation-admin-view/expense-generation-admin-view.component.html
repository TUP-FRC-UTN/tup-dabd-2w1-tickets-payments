<div class="container-fluid py-4 bg-light min-vh-100">
  <div class="row">
    <div class="col-12">
      <!-- Main Container -->
      <div class="container p-3 border border-2 rounded shadow-lg">
        <!-- Filter Row -->
        <div class="row mb-3">
          <!-- Search Type and Input -->
          <div class="col-md-4 position-relative">
            <div class="input-group">
              <div class="input-group-prepend">
                <select class="form-select flex-grow-0 w-auto" [(ngModel)]="searchType">
                  <option value="name">Nombre</option>
                  <option value="dni">DNI</option>
                  <option value="plot">Lote</option>
                </select>
              </div>
              <input 
                type="text" 
                class="form-control"
                [(ngModel)]="searchTerm"
                [placeholder]="searchType === 'plot' ? 'Ingrese número de lote' : (searchType === 'dni' ? 'Ingrese DNI' : 'Ingrese nombre')"
                (ngModelChange)="buscarUsuarios()"
                #searchInput
              >
              <button class="btn btn-outline-secondary" type="button" (click)="clearSearch()">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
            <!-- Filtered Users Dropdown -->
            <div class="position-absolute mt-1 w-100 z-1" *ngIf="filteredUsers.length > 0 && searchTerm.length > 0">
              <div class="list-group shadow">
                <button 
                  type="button"
                  class="list-group-item list-group-item-action"
                  *ngFor="let owner of filteredUsers"
                  (click)="seleccionarUsuario(owner)"
                >
                  {{ owner.name }} {{ owner.lastname }} - DNI: {{ owner.dni }}
                  <small class="d-block text-muted" *ngIf="owner.plots && owner.plots.length > 0">
                    Lotes: {{ getPlotNumbers(owner) }}
                  </small>
                </button>
              </div>
            </div>
          </div>

          <!-- Status Select -->
          <div class="col-md-2">
            <select 
              class="form-select"
              [(ngModel)]="filtros.estado" 
              (ngModelChange)="buscarBoletas()"
            >
              <option value="">Todos los estados</option>
              <option *ngFor="let estado of estados" [value]="estado">{{ estado }}</option>
            </select>
          </div>

          <!-- Date Range -->
          <div class="col-md-4">
            <div class="input-group">
              <input 
                type="date" 
                class="form-control"
                [(ngModel)]="filtros.desde" 
                (ngModelChange)="validateDates(); buscarBoletas()"
                [max]="maxDate"
                placeholder="Fecha desde"
              >
              <input 
                type="date" 
                class="form-control"
                [(ngModel)]="filtros.hasta" 
                (ngModelChange)="validateDates(); buscarBoletas()"
                [min]="filtros.desde"
                [max]="maxDate"
                placeholder="Fecha hasta"
              >
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="col-md-2 d-flex gap-2 justify-content-end">
            <button class="btn btn-danger bi bi-trash" title="Limpiar Filtros" (click)="limpiarFiltros()"></button>
            <button class="btn btn-success bi bi-file-earmark-excel" title="Exportar a Excel" (click)="exportToExcel()"></button>
            <button class="btn btn-danger bi bi-file-earmark-pdf" title="Exportar a PDF" (click)="exportToPDF()"></button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#filtrosAvanzados">
              <i class="bi bi-funnel-fill"></i>
            </button>
          </div>

        <!-- Results Table -->
        <div class="table-responsive">
          <table class="table table-hover border">
            <thead class="table-light">
              <tr>
                <th class="text-nowrap">Periodo</th>
                <th>Propietario</th>
                <th class="text-start text-nowrap">Monto Primer Pago</th>
                <th class="text-start text-nowrap">Monto Segundo Pago</th>
                <th class="text-start text-nowrap">Monto Pagado</th>
                <th>Estado</th>
                <th class="text-center">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let expense of expenses">
                <td class="text-nowrap font-monospace">{{expense.period}}</td>
                <td class="text-nowrap">{{getOwnerDisplayName(expense.owner_id)}}</td>
                <td class="text-nowrap font-monospace text-start">$ {{expense.first_expiration_amount | number:'1.2-2'}}</td>
                <td class="text-nowrap font-monospace text-start">$ {{expense.second_expiration_amount | number:'1.2-2'}}</td>
                <td class="text-nowrap font-monospace text-start">$ {{expense.first_expiration_amount | number:'1.2-2'}}</td>
                <td>
                  <span class="badge rounded-pill" 
                        [ngClass]="{
                          'text-bg-warning': expense.status === 'Pendiente',
                          'text-bg-success': expense.status === 'Pago',
                          'text-bg-danger': expense.status === 'Exceptuado'
                        }">
                    {{expense.status}}
                  </span>
                </td>
                <td class="text-center">
                  <button 
                    class="btn btn-light btn-sm" 
                    data-bs-toggle="modal"
                    data-bs-target="#detallesModal"
                    (click)="verDetalles(expense)"
                  >
                    Más info
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Loading State -->
        <div *ngIf="isLoading" class="text-center my-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
        </div>

        <!-- Error Message -->
        <div *ngIf="error" class="alert alert-danger" role="alert">
          {{error}}
        </div>

        <!-- No Results Message -->
        <div *ngIf="!isLoading && !error && expenses.length === 0" class="alert alert-info text-center">
          No se encontraron resultados
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Advanced Filters Modal -->
<div class="modal fade" id="filtrosAvanzados" tabindex="-1" aria-labelledby="filtrosAvanzadosLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="filtrosAvanzadosLabel">Filtros Avanzados</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Min Amount -->
        <div class="mb-3">
          <label for="montoMinimo" class="form-label">Monto Mínimo</label>
          <input 
            type="number" 
            class="form-control"
            id="montoMinimo"
            [(ngModel)]="filtros.montoMinimo" 
            name="montoMinimo"
          >
        </div>
        <div class="mb-3">
          <label for="periodo" class="form-label">Periodo</label>
          <select 
            class="form-select" 
            id="periodo"
            [(ngModel)]="filtros.periodo"
            name="periodo"
          >
            <option [ngValue]="null">Todos los periodos</option>
            <option *ngFor="let periodo of periodos" [value]="periodo">
              {{periodo}}
            </option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-primary" (click)="buscarBoletas()" data-bs-dismiss="modal">Aplicar Filtros</button>
        <button type="button" class="btn btn-outline-secondary" (click)="limpiarFiltros()">Limpiar Filtros</button>
      </div>
    </div>
  </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detallesModal" tabindex="-1" aria-labelledby="detallesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detallesModalLabel">Detalles del Gasto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" *ngIf="selectedExpense">
        <div class="container">
          <div class="row mb-3">
            <div class="col-md-6">
              <h6 class="mb-2">Información General</h6>
              <p class="mb-1"><strong>Período:</strong> {{selectedExpense.period}}</p>
              <p class="mb-1"><strong>Fecha de Emisión:</strong> {{selectedExpense.issueDate | date:'dd/MM/yyyy'}}</p>
              <p class="mb-1"><strong>Estado:</strong> 
                <span class="badge rounded-pill" 
                      [ngClass]="{
                        'text-bg-warning': selectedExpense.status === 'Pendiente',
                        'text-bg-success': selectedExpense.status === 'Pago',
                        'text-bg-danger': selectedExpense.status === 'Exceptuado'
                      }">
                  {{selectedExpense.status}}
                </span>
              </p>
            </div>
            <div class="col-md-6">
              <h6 class="mb-2">Información de Pago</h6>
              <p class="mb-1"><strong>1er Vencimiento:</strong> {{selectedExpense.first_expiration_date | date:'dd/MM/yyyy'}}</p>
              <p class="mb-1"><strong>Monto 1er Vencimiento:</strong> ${{selectedExpense.first_expiration_amount}}</p>
              <p class="mb-1"><strong>2do Vencimiento:</strong> {{selectedExpense.second_expiration_date | date:'dd/MM/yyyy'}}</p>
              <p class="mb-1"><strong>Monto 2do Vencimiento:</strong> ${{selectedExpense.second_expiration_amount}}</p>
            </div>
          </div>

          <!-- Payment Information (if paid) -->
          <div class="row mb-3" *ngIf="selectedExpense.status === 'Pago'">
            <div class="col-12">
              <h6 class="mb-2">Detalles del Pago</h6>
              <p class="mb-1"><strong>Método de Pago:</strong> {{selectedExpense.payment_method || 'No especificado'}}</p>
              <p class="mb-1"><strong>Plataforma:</strong> {{selectedExpense.payment_platform || 'No especificada'}}</p>
              <p class="mb-1"><strong>Monto Pagado:</strong> ${{selectedExpense.amount_payed}}</p>
              <p class="mb-1"><strong>Fecha de Pago:</strong> {{selectedExpense.paymentDate | date:'dd/MM/yyyy'}}</p>
            </div>
          </div>

          <!-- Document Buttons -->
          <div class="row">
            <div class="col-12">
              <div class="d-flex gap-2">
                <button class="btn btn-outline-danger" (click)="openPdf(selectedExpense.id)">
                  <i class="bi bi-file-earmark-pdf"></i>
                  Ver Factura
                </button>
                <p *ngIf="!selectedExpense.payment_id">Payment ID no disponible</p> <!-- Temporal para depuración -->
                <button 
                  class="btn btn-outline-primary" 
                  *ngIf="selectedExpense.payment_id"
                  (click)="openReceipt(selectedExpense)">
                  <i class="bi bi-file-earmark-text"></i>
                  Ver Comprobante
                  </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>