<div class="container-fluid py-4 bg-light min-vh-100">
  <div class="row">
    <div class="col-12">
      <!-- Main Container -->
      <div class="container p-3 border border-2 rounded shadow-lg">
        <!-- Filter Row -->
        <div class="row mb-3">
          <!-- Search Type and Input -->
          <div class="col-md-3 position-relative" style="padding-bottom: 12px;">
            <div class="input-group">
              <input type="text" class="form-control" [(ngModel)]="searchTerm" (ngModelChange)="searchUsers()"
                placeholder="Buscar por propietario, DNI o lote..." #searchInput>
            </div>

            <!-- Dropdown de usuarios filtrados -->
            <div class="position-absolute mt-1 w-100 z-1" *ngIf="filteredUsers.length > 0 && searchTerm.length > 0">
              <div class="list-group shadow">
                <button type="button" class="list-group-item list-group-item-action" *ngFor="let owner of filteredUsers"
                  (click)="selectUser(owner)">
                  {{ owner.name }} {{ owner.lastname }} - DNI: {{ owner.dni }}
                  <small class="d-block text-muted" *ngIf="owner.plots && owner.plots.length > 0">
                    Lotes: {{ getPlotNumbers(owner) }}
                  </small>
                </button>
              </div>
            </div>
          </div>

          <!-- Status Select -->
          <div class="col-md-2">
            <div class="position-relative">
              <button class="form-control d-flex justify-content-between align-items-center" type="button"
                (click)="showStatusDropdown = !showStatusDropdown" [attr.aria-expanded]="showStatusDropdown">
                <span class="text-truncate me-2">{{ getSelectedStatusText() }}</span>
                <i class="bi" [class.bi-chevron-down]="!showStatusDropdown" [class.bi-chevron-up]="showStatusDropdown">
                </i>
              </button>

              <ul class="dropdown-menu w-100 p-2 m-0 shadow-sm" [class.show]="showStatusDropdown"
                (click)="$event.stopPropagation()" style="max-height: 200px; overflow-y: auto;">
                <li *ngFor="let status of listStatus" class="dropdown-item px-2 py-1" style="cursor: pointer;">
                  <div class="form-check m-0">
                    <input type="checkbox" class="form-check-input" [id]="'estado-' + status"
                      [checked]="isSelectedStatus(status)" (change)="toggleStatus(status)">
                    <label class="form-check-label ms-2 w-100" [for]="'estado-' + status" style="cursor: pointer;">
                      {{ status }}
                    </label>
                  </div>
                </li>
              </ul>
            </div>
          </div>

          <!-- Date Range -->
          <div class="col-md-4 ">
            <div class="input-group">
              <input type="date" class="form-control" [(ngModel)]="filter.from"
                (ngModelChange)="validateDates(); searchTickets()" [max]="maxDate" placeholder="Fecha desde">
              <input type="date" class="form-control ms-2" [(ngModel)]="filter.until"
                (ngModelChange)="validateDates(); searchTickets()" [min]="filter.from" [max]="maxDate"
                placeholder="Fecha hasta">
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="col-md-3 d-flex gap-3 justify-content-end" style="padding-bottom: 12px;">
            <div class="d-flex gap-1">
              <button class="btn btn-primary" data-bs-toggle="modal" title="Filtros Avanzados"
                data-bs-target="#filtrosAvanzados">
                <i class="bi bi-sort-down-alt"></i>
              </button>
              <button class="btn btn-secondary bi bi-trash" title="Limpiar Filtros" (click)="cleanFilters()"></button>
            </div>
            <div>
              <button class="btn btn-warning" (click)="openModal()" style="color: white;">Facturación</button>
            </div>
            <div class="d-flex gap-1">
              <button class="btn btn-success bi bi-file-earmark-excel" title="Exportar a Excel"
                (click)="exportToExcel()"></button>
              <button class="btn btn-danger bi bi-file-earmark-pdf" title="Exportar a PDF"
                (click)="exportToPDF()"></button>
            </div>
            <!-- <button class="btn btn-warning bi bi-gear " title="Actualizar Multiplicadores" (click)="openModal()" style="color: white;"></button> -->

          </div>


          <!-- Results Table -->
          <div class="table-responsive">
            <table class="table table-striped border border-3 ">
              <thead class="table-light border-bottom border-dark">
                <tr>
                  <th (click)="ordenarPor('period')" class="text-nowrap">
                    Periodo
                    <i [ngClass]="{'fa fa-sort-asc': activeOrder === 'period' && directionOrder === 'asc',
                                 'fa fa-sort-desc': activeOrder === 'period' && directionOrder === 'desc',
                                 'fa fa-sort': activeOrder !== 'period'}" aria-hidden="true"></i>
                  </th>
                  <th>Estado</th>
                  <th class="text-nowrap">Propietario</th>
                  <th class="text-nowrap">DNI</th>
                  <th class="text-nowrap">Lote</th>
                  <th class="text-end text-nowrap">Monto Primer Pago</th>
                  <th class="text-end text-nowrap">Monto Segundo Pago</th>
                  <th class="text-end text-nowrap">Monto Pagado</th>
                  <th class="text-center">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let expense of pagedExpenses">
                  <td class="text-nowrap font-monospace">{{ expense.period }}</td>
                  <td>
                    <span class="badge rounded-pill" [ngClass]="{
                          'text-bg-warning': expense.status === 'Pendiente',
                          'text-bg-success': expense.status === 'Pago',
                          'text-bg-danger': expense.status === 'Exceptuado'
                        }">
                      {{ expense.status }}
                    </span>
                  </td>
                  <td class="text-nowrap">{{ getOwnerName(expense.owner_id) }}</td>
                  <td class="text-nowrap">{{ getOwnerDni(expense.owner_id) }}</td>
                  <td class="text-nowrap">{{ getOwnerPlots(expense.owner_id) }}</td>
                  <td class="text-nowrap text-end">$ {{ expense.first_expiration_amount | number:'1.2-2' }}</td>
                  <td class="text-nowrap text-end">$ {{ expense.second_expiration_amount | number:'1.2-2' }}</td>
                  <td class="text-nowrap text-end">$ {{ expense.actual_amount | number:'1.2-2' }}</td>
                  <td class="text-center">
                    <button class="btn btn-light btn-sm" type="button" data-bs-toggle="modal"
                      data-bs-target="#detallesModal" (click)="seeDetails(expense)">
                      <i class="bi bi-three-dots-vertical"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>

            <!-- Pagination controls -->
            <div class="d-flex justify-content-between align-items-center border-top pt-3">
              <!-- Items per page dropdown -->
              <div class="d-flex align-items-center">
                <span class="me-2">Mostrar</span>
                <select class="form-select form-select-sm" style="width: auto" [(ngModel)]="itemsPerPage"
                  (change)="onItemsPerPageChange()">
                  <option [value]="5">5</option>
                  <option [value]="10">10</option>
                  <option [value]="25">25</option>
                  <option [value]="50">50</option>
                </select>
              </div>

              <!-- Pagination buttons -->
              <nav aria-label="Page navigation" *ngIf="totalPages > 0">
                <ul class="pagination pagination-sm mb-0">
                  <!-- First page -->
                  <li class="page-item" [class.disabled]="currentPage === 1">
                    <a class="page-link" (click)="goToPage(1)"
                      [style.cursor]="currentPage === 1 ? 'not-allowed' : 'pointer'">
                      <i class="bi bi-chevron-double-left"></i>
                    </a>
                  </li>

                  <!-- Previous page -->
                  <li class="page-item" [class.disabled]="currentPage === 1">
                    <a class="page-link" (click)="goToPage(currentPage - 1)"
                      [style.cursor]="currentPage === 1 ? 'not-allowed' : 'pointer'">
                      <i class="bi bi-chevron-left"></i>
                    </a>
                  </li>

                  <!-- Page numbers -->
                  <li class="page-item" *ngFor="let page of visiblePages" [class.active]="page === currentPage">
                    <a class="page-link" (click)="goToPage(page)" style="cursor: pointer">{{ page }}</a>
                  </li>

                  <!-- Next page -->
                  <li class="page-item" [class.disabled]="currentPage === totalPages">
                    <a class="page-link" (click)="goToPage(currentPage + 1)"
                      [style.cursor]="currentPage === totalPages ? 'not-allowed' : 'pointer'">
                      <i class="bi bi-chevron-right"></i>
                    </a>
                  </li>

                  <!-- Last page -->
                  <li class="page-item" [class.disabled]="currentPage === totalPages">
                    <a class="page-link" (click)="goToPage(totalPages)"
                      [style.cursor]="currentPage === totalPages ? 'not-allowed' : 'pointer'">
                      <i class="bi bi-chevron-double-right"></i>
                    </a>
                  </li>
                </ul>
              </nav>
            </div>
          </div>

          <!-- Loading State -->
          <div *ngIf="isLoading" class="text-center my-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
          </div>

          <!-- Error Message -->
          <div *ngIf="error" class="alert alert-danger" role="alert">
            {{error}}
          </div>

          <!-- No Results Message -->
          <div *ngIf="!isLoading && !error && expenses.length === 0" class="alert alert-info text-center">
            No se encontraron resultados
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cambiar Multiplicadores -->

  <!-- Modal Principal de Multiplicadores -->
  <div class="modal fade" id="multipliersModal" tabindex="-1" aria-labelledby="multipliersModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="multipliersModalLabel">Configuración de Expensas</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" (click)="onModalClose()"
            aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Spinner de carga -->
          <div *ngIf="isLoadingMultipliers" class="text-center my-3">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
          </div>

          <!-- Mensaje de error -->
          <div *ngIf="multiplierError" class="alert alert-danger">
            {{ multiplierError }}
          </div>

          <!-- Formulario -->
          <div [class.d-none]="isLoadingMultipliers">
            <!-- Día de Generación -->
            <div class="mb-4">
              <label for="generationDayInput" class="form-label">Día de Generación de Expensas:</label>
              <div class="input-group">
                <input type="number" id="generationDayInput" [(ngModel)]="generationDay" class="form-control" min="1"
                  max="28" [class.is-invalid]="!isValidGenerationDay()"
                  [disabled]="!!fieldModified && fieldModified !== 'generationDay'"
                  (focus)="onFieldFocus('generationDay')" (blur)="onFieldBlur()"
                  (ngModelChange)="onFieldChange('generationDay')" />
                <span class="input-group-text">del mes</span>
              </div>
              <div class="form-text" [class.text-danger]="!isValidGenerationDay()">
                El día debe estar entre 1 y 28
              </div>
            </div>

            <hr class="my-4">

            <!-- Multiplicadores -->
            <div class="mb-3">
              <label for="latePaymentInput" class="form-label">Porcentaje de pagos atrasados:</label>
              <div class="input-group">
                <input type="number" id="latePaymentInput" [(ngModel)]="latePaymentPercentage" class="form-control"
                  min="0" max="100" [disabled]="!!fieldModified && fieldModified !== 'latePayment'"
                  (focus)="onFieldFocus('latePayment')" (blur)="onFieldBlur()"
                  (ngModelChange)="onFieldChange('latePayment')" />
                <span class="input-group-text">%</span>
              </div>
            </div>

            <div class="mb-3">
              <label for="expirationInput" class="form-label">Porcentaje de vencimiento:</label>
              <div class="input-group">
                <input type="number" id="expirationInput" [(ngModel)]="expirationPercentage" class="form-control"
                  min="0" max="100" [disabled]="!!fieldModified && fieldModified !== 'expiration'"
                  (focus)="onFieldFocus('expiration')" (blur)="onFieldBlur()"
                  (ngModelChange)="onFieldChange('expiration')" />
                <span class="input-group-text">%</span>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
            (click)="onModalClose()">Cerrar</button>
          <button type="button" class="btn btn-primary" (click)="handleSaveClick()"
            [disabled]="isLoadingMultipliers || !fieldModified || !isValidGenerationDay()">
            Guardar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Observación -->
  <div class="modal fade" id="observationModal" tabindex="-1" aria-labelledby="observationModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="observationModalLabel">Justificación de los Cambios</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="observationInput" class="form-label">Por favor, explique el motivo de los cambios:</label>
            <textarea id="observationInput" [(ngModel)]="observation" class="form-control" rows="3" required></textarea>
          </div>
          <!-- Resumen de cambios -->
          <div class="mt-3 p-3 bg-light rounded" *ngIf="getChangeSummary().length > 0">
            <h6>Resumen de cambios:</h6>
            <ul class="mb-0">
              <li *ngFor="let change of getChangeSummary()">{{ change }}</li>
            </ul>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" (click)="saveChanges()" [disabled]="!observation.trim()">
            Confirmar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Observación de Expensa -->
  <div class="modal fade" id="observationModalExpenses" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Justificación de los Cambios</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="observationInput" class="form-label">Por favor, explique el motivo de los cambios:</label>
            <textarea id="observationInput" [(ngModel)]="observation" class="form-control" rows="3" required></textarea>
          </div>
          <!-- Resumen de cambios -->
          <div class="mt-3 p-3 bg-light rounded" *ngIf="getChangeSummaryExpenses().length > 0">
            <h6>Resumen de cambios:</h6>
            <ul class="mb-0">
              <li *ngFor="let change of getChangeSummaryExpenses()">{{ change }}</li>
            </ul>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" (click)="saveChangesExpenses()"
            [disabled]="!observation.trim()">
            Confirmar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Advanced Filters Modal -->
  <div class="modal fade" id="filtrosAvanzados" tabindex="-1" aria-labelledby="filtrosAvanzadosLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="filtrosAvanzadosLabel">Filtros Avanzados</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Min Amount -->
          <div class="mb-3">
            <label for="montoMinimo" class="form-label">Monto Mínimo</label>
            <input type="number" class="form-control" id="montoMinimo" [(ngModel)]="filter.minimumAmount"
              name="montoMinimo">
          </div>
          <div class="mb-3">
            <label for="periodo" class="form-label">Periodo</label>
            <div class="dropdown">
              <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dropdownPeriodos"
                data-bs-toggle="dropdown" aria-expanded="false">
                Seleccionar Periodos
              </button>
              <ul class="dropdown-menu" aria-labelledby="dropdownPeriodos">
                <li *ngFor="let periodo of periodos">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" [value]="periodo.value"
                      (change)="toggleSelectedPeriod(periodo.value)"
                      [checked]="filter.selectedPeriod.includes(periodo.value)">
                    <label class="form-check-label">
                      {{ periodo.label }}
                    </label>
                  </div>
                </li>
              </ul>
            </div>
          </div>
          <div class="mb-3">
            <label for="typedoc" class="form-label">Tipo Documento</label>
            <select class="form-select" id="doc" [(ngModel)]="filter.typedoc" name="doc">
              <option *ngFor="let doc of typedoc" [value]="doc">
                {{doc}}
              </option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-primary" (click)="searchTickets()"
            data-bs-dismiss="modal">Aplicar</button>
          <button type="button" class="btn btn-primary bi bi-trash" title="Limpiar Filtros"
            (click)="cleanFilters()"></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Details Modal -->
  <div class="modal fade" id="detallesModal" tabindex="-1" aria-labelledby="detallesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="detallesModalLabel">Detalles de la Boleta</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" *ngIf="selectedExpense">
          <div class="container">
            <!-- Grid layout for better organization -->
            <div class="row g-3">
              <!-- Información del Propietario -->
              <div class="col-12">
                <div class="card">
                  <div class="card-body">
                    <h6 class="card-title">Información del Propietario</h6>
                    <p class="mb-0">{{ getOwnerDisplayName(selectedExpense.owner_id) }}</p>
                  </div>
                </div>
              </div>

              <!-- Fechas de Vencimiento -->
              <div class="col-md-6">
                <div class="card">
                  <div class="card-body">
                    <h6 class="card-title">Primer Vencimiento</h6>
                    <div class="mb-2">
                      <label class="form-label">Fecha</label>
                      <input type="date" [(ngModel)]="updatedExpense.first_expiration_date"
                        (change)="validateExpirationDates()" class="form-control"
                        [max]="updatedExpense.second_expiration_date">
                    </div>
                    <div>
                      <label class="form-label">Monto</label>
                      <p class="form-control-plaintext">${{ selectedExpense.first_expiration_amount }}</p>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card">
                  <div class="card-body">
                    <h6 class="card-title">Segundo Vencimiento</h6>
                    <div class="mb-2">
                      <label class="form-label">Fecha</label>
                      <input type="date" [(ngModel)]="updatedExpense.second_expiration_date"
                        (change)="validateExpirationDates()" class="form-control"
                        [min]="updatedExpense.first_expiration_date">
                    </div>
                    <div>
                      <label class="form-label">Monto</label>
                      <input type="number" [(ngModel)]="updatedExpense.second_expiration_amount"
                        (ngModelChange)="calculateExpirationMultiplier()" class="form-control"
                        [min]="selectedExpense.first_expiration_amount">
                    </div>
                  </div>
                </div>
              </div>

              <!-- Estado -->
              <div class="col-12">
                <div class="card">
                  <div class="card-body">
                    <h6 class="card-title">Estado</h6>
                    <select [(ngModel)]="updatedExpense.status" class="form-select">
                      <option value="Pago">Pago</option>
                      <option value="Pendiente">Pendiente</option>
                      <option value="Exceptuado">Exceptuado</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Documentos -->
              <div class="col-12">
                <div class="card">
                  <div class="card-body">
                    <h6 class="card-title">Documentos</h6>
                    <div class="d-flex gap-2">
                      <button class="btn btn-outline-danger" (click)="openPdf(selectedExpense.id)">
                        <i class="bi bi-file-earmark-pdf"></i> Ver Factura
                      </button>
                      <button class="btn btn-outline-primary" *ngIf="selectedExpense.payment_id"
                        (click)="openReceipt(selectedExpense)">
                        <i class="bi bi-file-earmark-text"></i> Ver Comprobante
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-primary" [disabled]="!hasChangesExpense()"
            (click)="openObservationModal()">
            Guardar Cambios
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de info -->
  <div class="modal fade" id="infoModal" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">FinanceManager info</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          Lorem ipsum dolor sit amet consectetur adipisicing elit. Beatae itaque soluta provident eum facilis eaque
          tenetur. Dolorem aut, animi dolore dolor placeat, natus aliquam doloremque consequatur velit odio, magnam
          amet.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>