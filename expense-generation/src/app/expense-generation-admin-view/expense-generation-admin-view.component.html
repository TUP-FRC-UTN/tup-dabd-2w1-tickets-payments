<div class="container-fluid py-4 bg-light min-vh-100">
  <div class="row">
    <div class="col-12">
      <!-- Main Container -->
      <div class="container p-3 border border-2 rounded shadow-lg">
        <!-- Filter Row -->
        <div class="row mb-3">
          <!-- Search Type and Input -->
          <div class="col-md-3 position-relative">
            <div class="input-group">
              <input
                type="text"
                class="form-control"
                [(ngModel)]="searchTerm"
                (ngModelChange)="buscarUsuarios()"
                placeholder="Buscar"
                #searchInput
              >
            </div>
            
            <!-- Dropdown de usuarios filtrados -->
            <div class="position-absolute mt-1 w-100 z-1" *ngIf="filteredUsers.length > 0 && searchTerm.length > 0">
              <div class="list-group shadow">
                <button 
                  type="button"
                  class="list-group-item list-group-item-action"
                  *ngFor="let owner of filteredUsers"
                  (click)="seleccionarUsuario(owner)"
                >
                  {{ owner.name }} {{ owner.lastname }} - DNI: {{ owner.dni }}
                  <small class="d-block text-muted" *ngIf="owner.plots && owner.plots.length > 0">
                    Lotes: {{ getPlotNumbers(owner) }}
                  </small>
                </button>
              </div>
            </div>
          </div>

          <!-- Status Select -->
          <div class="col-md-2">
            <select 
              class="form-select"
              [(ngModel)]="filtros.estado" 
              (ngModelChange)="buscarBoletas()"
            >
              <option value="">Seleccionar estado</option>
              <option *ngFor="let estado of estados" [value]="estado">{{ estado }}</option>
            </select>
          </div>

          <!-- Date Range -->
          <div class="col-md-4 ">
            <div class="input-group">
              <input 
                type="date" 
                class="form-control"
                [(ngModel)]="filtros.desde" 
                (ngModelChange)="validateDates(); buscarBoletas()"
                [max]="maxDate"
                placeholder="Fecha desde"
              >
              <input 
                type="date" 
                class="form-control ms-2"
                [(ngModel)]="filtros.hasta" 
                (ngModelChange)="validateDates(); buscarBoletas()"
                [min]="filtros.desde"
                [max]="maxDate"
                placeholder="Fecha hasta"
              >
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="col-md-3 d-flex gap-3 justify-content-end">
            <button class="btn  bi bi-trash" title="Limpiar Filtros" (click)="limpiarFiltros()" style="color: gray; background-color: white; border: 1px solid gray"></button>
            <button class="btn btn-success bi bi-file-earmark-excel" title="Exportar a Excel" (click)="exportToExcel()"></button>
            <button class="btn btn-danger bi bi-file-earmark-pdf" title="Exportar a PDF" (click)="exportToPDF()"></button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#filtrosAvanzados">
              <i class="bi bi-funnel-fill"></i>
            </button>
            <button class="btn bi bi-arrow-clockwise " style="background-color: #ffc107; color: white;" title="Actualizar Multiplicadores" (click)="openModal()"></button>
          </div>
          
          
          <!-- Cambiar Multiplicadores -->

          <!-- Modal Principal de Multiplicadores -->
    <div class="modal fade" id="multipliersModal" tabindex="-1" aria-labelledby="multipliersModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="multipliersModalLabel">Configuración de Expensas</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Spinner de carga -->
            <div *ngIf="isLoadingMultipliers" class="text-center my-3">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
            </div>

            <!-- Mensaje de error -->
            <div *ngIf="multiplierError" class="alert alert-danger">
              {{ multiplierError }}
            </div>

            <!-- Formulario -->
            <div [class.d-none]="isLoadingMultipliers">
              <!-- Día de Generación -->
              <div class="mb-4">
                <label for="generationDayInput" class="form-label">Día de Generación de Expensas:</label>
                <div class="input-group">
                  <input
                    type="number"
                    id="generationDayInput"
                    [(ngModel)]="generationDay"
                    class="form-control"
                    min="1"
                    max="28"
                    [class.is-invalid]="!isValidGenerationDay()"
                  />
                  <span class="input-group-text">del mes</span>
                </div>
                <div class="form-text" [class.text-danger]="!isValidGenerationDay()">
                  El día debe estar entre 1 y 28
                </div>
              </div>

              <hr class="my-4">

              <!-- Multiplicadores -->
              <div class="mb-3">
                <label for="latePaymentInput" class="form-label">Porcentaje de pagos atrasados:</label>
                <div class="input-group">
                  <input
                    type="number"
                    id="latePaymentInput"
                    [(ngModel)]="latePaymentPercentage"
                    class="form-control"
                    min="0"
                    max="100"
                    (ngModelChange)="updateMultiplierFromPercentage('latePayment', $event)"
                  />
                  <span class="input-group-text">%</span>
                </div>
              </div>

              <div class="mb-3">
                <label for="expirationInput" class="form-label">Porcentaje de vencimiento:</label>
                <div class="input-group">
                  <input
                    type="number"
                    id="expirationInput"
                    [(ngModel)]="expirationPercentage"
                    class="form-control"
                    min="0"
                    max="100"
                    (ngModelChange)="updateMultiplierFromPercentage('expiration', $event)"
                  />
                  <span class="input-group-text">%</span>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button
              type="button"
              class="btn btn-primary"
              (click)="handleSaveClick()"
              [disabled]="isLoadingMultipliers || (!hasChanges() && generationDay === originalGenerationDay) || !isValidGenerationDay()"
            >
              Guardar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Observación -->
    <div class="modal fade" id="observationModal" tabindex="-1" aria-labelledby="observationModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="observationModalLabel">Justificación de los Cambios</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="observationInput" class="form-label">Por favor, explique el motivo de los cambios:</label>
              <textarea
                id="observationInput"
                [(ngModel)]="observation"
                class="form-control"
                rows="3"
                required
              ></textarea>
            </div>
            <!-- Resumen de cambios -->
            <div class="mt-3 p-3 bg-light rounded" *ngIf="getChangeSummary().length > 0">
              <h6>Resumen de cambios:</h6>
              <ul class="mb-0">
                <li *ngFor="let change of getChangeSummary()">{{ change }}</li>
              </ul>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button
              type="button"
              class="btn btn-primary"
              (click)="saveChanges()"
              [disabled]="!observation.trim()">
              Confirmar
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Modal de Observación de Expensa -->
    <div class="modal fade" id="observationModalExpenses" tabindex="-1" data-bs-backdrop="static">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Justificación de los Cambios</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="observationInput" class="form-label">Por favor, explique el motivo de los cambios:</label>
              <textarea
                id="observationInput"
                [(ngModel)]="observation"
                class="form-control"
                rows="3"
                required></textarea>
            </div>
            <!-- Resumen de cambios -->
            <div class="mt-3 p-3 bg-light rounded" *ngIf="getChangeSummaryExpenses().length > 0">
              <h6>Resumen de cambios:</h6>
              <ul class="mb-0">
                <li *ngFor="let change of getChangeSummaryExpenses()">{{ change }}</li>
              </ul>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button
              type="button"
              class="btn btn-primary"
              (click)="saveChangesExpenses()"
              [disabled]="!observation.trim()">
              Confirmar
            </button>
          </div>
        </div>
      </div>
    </div>
    

        <!-- Results Table -->
        <div class="table-responsive">
          <table class="table table-hover border">
            <thead class="table-light">
              <tr>
                <th class="text-nowrap">Periodo</th>
                <th>Estado</th>
                <th class="text-nowrap">Propietario</th>
                <th class="text-nowrap">DNI</th>
                <th class="text-nowrap">Lote</th>
                <th class="text-start text-nowrap">Monto Primer Pago</th>
                <th class="text-start text-nowrap">Monto Segundo Pago</th>
                <th class="text-start text-nowrap">Monto Pagado</th>
                <th class="text-center">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let expense of expenses">
                <td class="text-nowrap font-monospace">{{ expense.period }}</td>
                <td>
                  <span class="badge rounded-pill" 
                        [ngClass]="{
                          'text-bg-warning': expense.status === 'Pendiente',
                          'text-bg-success': expense.status === 'Pago',
                          'text-bg-danger': expense.status === 'Exceptuado'
                        }">
                    {{ expense.status }}
                  </span>
                </td>
                <td class="text-nowrap">{{ getOwnerName(expense.owner_id) }}</td>
                <td class="text-nowrap">{{ getOwnerDni(expense.owner_id) }}</td>
                <td class="text-nowrap">{{ getOwnerPlots(expense.owner_id) }}</td>
                <td class="text-nowrap  text-start">$ {{ expense.first_expiration_amount | number:'1.2-2' }}</td>
                <td class="text-nowrap  text-start">$ {{ expense.second_expiration_amount | number:'1.2-2' }}</td>
                <td class="text-nowrap  text-start">$ {{ expense.amount_payed| number:'1.2-2' }}</td>
                <td class="text-center">
                  <button
                    class="btn btn-light btn-sm"
                    type="button"
                    data-bs-toggle="modal"
                    data-bs-target="#detallesModal"
                    (click)="verDetalles(expense)">
                    <i class="bi bi-three-dots-vertical"></i> 
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Loading State -->
        <div *ngIf="isLoading" class="text-center my-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
        </div>

        <!-- Error Message -->
        <div *ngIf="error" class="alert alert-danger" role="alert">
          {{error}}
        </div>

        <!-- No Results Message -->
        <div *ngIf="!isLoading && !error && expenses.length === 0" class="alert alert-info text-center">
          No se encontraron resultados
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Advanced Filters Modal -->
<div class="modal fade" id="filtrosAvanzados" tabindex="-1" aria-labelledby="filtrosAvanzadosLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="filtrosAvanzadosLabel">Filtros Avanzados</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Min Amount -->
        <div class="mb-3">
          <label for="montoMinimo" class="form-label">Monto Mínimo</label>
          <input 
            type="number" 
            class="form-control"
            id="montoMinimo"
            [(ngModel)]="filtros.montoMinimo" 
            name="montoMinimo"
          >
        </div>
        <div class="mb-3">
          <label for="periodo" class="form-label">Periodo</label>
          <select 
            class="form-select" 
            id="periodo"
            [(ngModel)]="filtros.periodo"
            name="periodo"
          >
            <option [ngValue]="null">Todos los periodos</option>
            <option *ngFor="let periodo of periodos" [value]="periodo">
              {{periodo}}
            </option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-primary" (click)="buscarBoletas()" data-bs-dismiss="modal">Aplicar Filtros</button>
        <button type="button" class="btn btn-outline-secondary" (click)="limpiarFiltros()">Limpiar Filtros</button>
      </div>
    </div>
  </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detallesModal" tabindex="-1" aria-labelledby="detallesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detallesModalLabel">Detalles de la Boleta</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" *ngIf="selectedExpense">
        <div class="container">
          <!-- Grid layout for better organization -->
          <div class="row g-3">
            <!-- Información del Propietario -->
            <div class="col-12">
              <div class="card">
                <div class="card-body">
                  <h6 class="card-title">Información del Propietario</h6>
                  <p class="mb-0">{{ getOwnerDisplayName(selectedExpense.owner_id) }}</p>
                </div>
              </div>
            </div>

            <!-- Fechas de Vencimiento -->
            <div class="col-md-6">
              <div class="card">
                <div class="card-body">
                  <h6 class="card-title">Primer Vencimiento</h6>
                  <div class="mb-2">
                    <label class="form-label">Fecha</label>
                    <input
                      type="date"
                      [(ngModel)]="updatedExpense.first_expiration_date"
                      (change)="validateExpirationDates()"
                      class="form-control"
                      [max]="updatedExpense.second_expiration_date">
                  </div>
                  <div>
                    <label class="form-label">Monto</label>
                    <p class="form-control-plaintext">${{ selectedExpense.first_expiration_amount }}</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card">
                <div class="card-body">
                  <h6 class="card-title">Segundo Vencimiento</h6>
                  <div class="mb-2">
                    <label class="form-label">Fecha</label>
                    <input
                      type="date"
                      [(ngModel)]="updatedExpense.second_expiration_date"
                      (change)="validateExpirationDates()"
                      class="form-control"
                      [min]="updatedExpense.first_expiration_date">
                  </div>
                  <div>
                    <label class="form-label">Monto</label>
                    <input
                      type="number"
                      [(ngModel)]="updatedExpense.second_expiration_amount"
                      (ngModelChange)="calculateExpirationMultiplier()"
                      class="form-control"
                      [min]="selectedExpense.first_expiration_amount">
                  </div>
                </div>
              </div>
            </div>

            <!-- Estado -->
            <div class="col-12">
              <div class="card">
                <div class="card-body">
                  <h6 class="card-title">Estado</h6>
                  <select
                    [(ngModel)]="updatedExpense.status"
                    class="form-select">
                    <option value="Pago">Pago</option>
                    <option value="Pendiente">Pendiente</option>
                    <option value="Exceptuado">Exceptuado</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Documentos -->
            <div class="col-12">
              <div class="card">
                <div class="card-body">
                  <h6 class="card-title">Documentos</h6>
                  <div class="d-flex gap-2">
                    <button class="btn btn-outline-danger" (click)="openPdf(selectedExpense.id)">
                      <i class="bi bi-file-earmark-pdf"></i> Ver Factura
                    </button>
                    <button
                      class="btn btn-outline-primary"
                      *ngIf="selectedExpense.payment_id"
                      (click)="openReceipt(selectedExpense)">
                      <i class="bi bi-file-earmark-text"></i> Ver Comprobante
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button
          type="button"
          class="btn btn-primary"
          [disabled]="!hasChangesExpense()"
          (click)="openObservationModal()">
          Guardar Cambios
        </button>
      </div>
    </div>
  </div>
</div>
